// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © scientificbest

//@version=5
indicator("Engulfing Bar Play [SB]", "EBP [SB]", overlay=true, max_boxes_count=200, max_labels_count=500, max_lines_count=500)

// ============================================================================
// INPUTS
// ============================================================================
htfTimeframe = input.timeframe("60", "HTF Timeframe", group="Settings")
consecutiveCandles = input.int(3, "Consecutive Candles Before Pattern", minval=1, maxval=10, group="Settings")

// Display options
showHtfBoxes = input.bool(true, "Show HTF Candle Boxes", group="Preferences")
showSignals = input.bool(true, "Show Signal Markers", group="Preferences")

// Colors
bullishBoxColor = input.color(color.new(color.green, 80), "Bullish HTF Box", group="Colors")
bearishBoxColor = input.color(color.new(color.red, 80), "Bearish HTF Box", group="Colors")
bullishSignalColor = input.color(color.green, "Bullish Signal", group="Colors")
bearishSignalColor = input.color(color.red, "Bearish Signal", group="Colors")
highRayColor = input.color(color.red, "High Ray", group="Colors")
lowRayColor = input.color(color.green, "Low Ray", group="Colors")
openMarkerColor = input.color(color.orange, "Open Marker", group="Colors")

// ============================================================================
// HTF DATA
// ============================================================================
// Get the CURRENT HTF candle's developing values (candle N)
htfOpen = request.security(syminfo.tickerid, htfTimeframe, open, lookahead=barmerge.lookahead_on)
htfHigh = request.security(syminfo.tickerid, htfTimeframe, high, lookahead=barmerge.lookahead_on)
htfLow = request.security(syminfo.tickerid, htfTimeframe, low, lookahead=barmerge.lookahead_on)
htfClose = request.security(syminfo.tickerid, htfTimeframe, close, lookahead=barmerge.lookahead_on)
htfTime = request.security(syminfo.tickerid, htfTimeframe, time, lookahead=barmerge.lookahead_on)

// Get PREVIOUS HTF candle's values (candle N-1) - the one that just completed (engulfing candle)
htfOpen_1 = request.security(syminfo.tickerid, htfTimeframe, open[1], lookahead=barmerge.lookahead_on)
htfHigh_1 = request.security(syminfo.tickerid, htfTimeframe, high[1], lookahead=barmerge.lookahead_on)
htfLow_1 = request.security(syminfo.tickerid, htfTimeframe, low[1], lookahead=barmerge.lookahead_on)
htfClose_1 = request.security(syminfo.tickerid, htfTimeframe, close[1], lookahead=barmerge.lookahead_on)

// Get HTF candle N-2 (the engulfed candle)
htfOpen_2 = request.security(syminfo.tickerid, htfTimeframe, open[2], lookahead=barmerge.lookahead_on)
htfHigh_2 = request.security(syminfo.tickerid, htfTimeframe, high[2], lookahead=barmerge.lookahead_on)
htfLow_2 = request.security(syminfo.tickerid, htfTimeframe, low[2], lookahead=barmerge.lookahead_on)
htfClose_2 = request.security(syminfo.tickerid, htfTimeframe, close[2], lookahead=barmerge.lookahead_on)

// Get candles N-3 through N-12 for consecutive candle check (up to 10 candles back)
htfOpen_3 = request.security(syminfo.tickerid, htfTimeframe, open[3], lookahead=barmerge.lookahead_on)
htfClose_3 = request.security(syminfo.tickerid, htfTimeframe, close[3], lookahead=barmerge.lookahead_on)
htfOpen_4 = request.security(syminfo.tickerid, htfTimeframe, open[4], lookahead=barmerge.lookahead_on)
htfClose_4 = request.security(syminfo.tickerid, htfTimeframe, close[4], lookahead=barmerge.lookahead_on)
htfOpen_5 = request.security(syminfo.tickerid, htfTimeframe, open[5], lookahead=barmerge.lookahead_on)
htfClose_5 = request.security(syminfo.tickerid, htfTimeframe, close[5], lookahead=barmerge.lookahead_on)
htfOpen_6 = request.security(syminfo.tickerid, htfTimeframe, open[6], lookahead=barmerge.lookahead_on)
htfClose_6 = request.security(syminfo.tickerid, htfTimeframe, close[6], lookahead=barmerge.lookahead_on)
htfOpen_7 = request.security(syminfo.tickerid, htfTimeframe, open[7], lookahead=barmerge.lookahead_on)
htfClose_7 = request.security(syminfo.tickerid, htfTimeframe, close[7], lookahead=barmerge.lookahead_on)
htfOpen_8 = request.security(syminfo.tickerid, htfTimeframe, open[8], lookahead=barmerge.lookahead_on)
htfClose_8 = request.security(syminfo.tickerid, htfTimeframe, close[8], lookahead=barmerge.lookahead_on)
htfOpen_9 = request.security(syminfo.tickerid, htfTimeframe, open[9], lookahead=barmerge.lookahead_on)
htfClose_9 = request.security(syminfo.tickerid, htfTimeframe, close[9], lookahead=barmerge.lookahead_on)
htfOpen_10 = request.security(syminfo.tickerid, htfTimeframe, open[10], lookahead=barmerge.lookahead_on)
htfClose_10 = request.security(syminfo.tickerid, htfTimeframe, close[10], lookahead=barmerge.lookahead_on)
htfOpen_11 = request.security(syminfo.tickerid, htfTimeframe, open[11], lookahead=barmerge.lookahead_on)
htfClose_11 = request.security(syminfo.tickerid, htfTimeframe, close[11], lookahead=barmerge.lookahead_on)
htfOpen_12 = request.security(syminfo.tickerid, htfTimeframe, open[12], lookahead=barmerge.lookahead_on)
htfClose_12 = request.security(syminfo.tickerid, htfTimeframe, close[12], lookahead=barmerge.lookahead_on)

// Detect when a new HTF candle starts
bool htfNewCandle = ta.change(htfTime) != 0

// ============================================================================
// HELPER FUNCTIONS
// ============================================================================
// Check if candle at offset is bearish (for bullish engulfing filter)
isBearishAtOffset(int offset) =>
    switch offset
        3 => htfClose_3 < htfOpen_3
        4 => htfClose_4 < htfOpen_4
        5 => htfClose_5 < htfOpen_5
        6 => htfClose_6 < htfOpen_6
        7 => htfClose_7 < htfOpen_7
        8 => htfClose_8 < htfOpen_8
        9 => htfClose_9 < htfOpen_9
        10 => htfClose_10 < htfOpen_10
        11 => htfClose_11 < htfOpen_11
        12 => htfClose_12 < htfOpen_12
        => false

// Check if candle at offset is bullish (for bearish engulfing filter)
isBullishAtOffset(int offset) =>
    switch offset
        3 => htfClose_3 > htfOpen_3
        4 => htfClose_4 > htfOpen_4
        5 => htfClose_5 > htfOpen_5
        6 => htfClose_6 > htfOpen_6
        7 => htfClose_7 > htfOpen_7
        8 => htfClose_8 > htfOpen_8
        9 => htfClose_9 > htfOpen_9
        10 => htfClose_10 > htfOpen_10
        11 => htfClose_11 > htfOpen_11
        12 => htfClose_12 > htfOpen_12
        => false

// Check if N consecutive candles before the engulfed candle are bearish
// For bullish engulfing: candles N-3 through N-(2+consecutiveCandles) must be bearish
checkConsecutiveBearish(int count) =>
    bool allBearish = true
    for i = 0 to count - 1
        if not isBearishAtOffset(3 + i)
            allBearish := false
            break
    allBearish

// Check if N consecutive candles before the engulfed candle are bullish
// For bearish engulfing: candles N-3 through N-(2+consecutiveCandles) must be bullish
checkConsecutiveBullish(int count) =>
    bool allBullish = true
    for i = 0 to count - 1
        if not isBullishAtOffset(3 + i)
            allBullish := false
            break
    allBullish

// ============================================================================
// HTF CANDLE TRACKING
// ============================================================================
var int currentHtfStartBar = na
var int htfCandleCount = 0

// Store completed HTF candle data (N-1) for drawing
var float completedHtfOpen = na
var float completedHtfHigh = na
var float completedHtfLow = na
var float completedHtfClose = na
var int completedHtfStartBar = na
var int completedHtfEndBar = na

// Arrays to track rays and when they were created
var array<line> rayLines = array.new_line()
var array<int> rayBirthCandle = array.new_int()

// When new HTF candle starts
if htfNewCandle
    htfCandleCount += 1

    // Cut off rays that are 2 HTF candles old
    int i = array.size(rayLines) - 1
    while i >= 0
        int birthCandle = array.get(rayBirthCandle, i)
        if htfCandleCount - birthCandle >= 2
            line rayLine = array.get(rayLines, i)
            line.set_extend(rayLine, extend.none)
            line.set_x2(rayLine, bar_index - 1)
            array.remove(rayLines, i)
            array.remove(rayBirthCandle, i)
        i -= 1

    // Save completed candle data
    completedHtfOpen := htfOpen_1
    completedHtfHigh := htfHigh_1
    completedHtfLow := htfLow_1
    completedHtfClose := htfClose_1
    completedHtfStartBar := currentHtfStartBar
    completedHtfEndBar := bar_index - 1

    currentHtfStartBar := bar_index

// ============================================================================
// HTF CANDLE BOXES
// ============================================================================
var box currentHtfBox = na
var box currentHtfBodyBox = na

if showHtfBoxes and not na(currentHtfStartBar)
    if not na(currentHtfBox)
        box.delete(currentHtfBox)
    if not na(currentHtfBodyBox)
        box.delete(currentHtfBodyBox)

    bool isBullish = htfClose >= htfOpen
    color boxColor = isBullish ? bullishBoxColor : bearishBoxColor

    currentHtfBox := box.new(currentHtfStartBar, htfHigh, bar_index, htfLow,
         bgcolor=boxColor, border_color=color.new(isBullish ? color.green : color.red, 50), border_width=1)

    float bodyTop = math.max(htfOpen, htfClose)
    float bodyBottom = math.min(htfOpen, htfClose)
    currentHtfBodyBox := box.new(currentHtfStartBar, bodyTop, bar_index, bodyBottom,
         bgcolor=boxColor, border_color=color.new(isBullish ? color.green : color.red, 50), border_width=1)

if htfNewCandle and showHtfBoxes and not na(completedHtfStartBar) and not na(completedHtfEndBar)
    bool wasHtfBullish = completedHtfClose >= completedHtfOpen
    color completedBoxColor = wasHtfBullish ? bullishBoxColor : bearishBoxColor

    box.new(completedHtfStartBar, completedHtfHigh, completedHtfEndBar, completedHtfLow,
         bgcolor=completedBoxColor, border_color=color.new(wasHtfBullish ? color.green : color.red, 30), border_width=2)

    float completedBodyTop = math.max(completedHtfOpen, completedHtfClose)
    float completedBodyBottom = math.min(completedHtfOpen, completedHtfClose)
    box.new(completedHtfStartBar, completedBodyTop, completedHtfEndBar, completedBodyBottom,
         bgcolor=completedBoxColor, border_color=color.new(wasHtfBullish ? color.green : color.red, 30), border_width=2)

// ============================================================================
// ENGULFING BAR PLAY DETECTION
// ============================================================================
// Pattern structure (looking back from current bar):
//   N-1: Engulfing candle (just completed)
//   N-2: Engulfed candle (opposite direction)
//   N-3 to N-(2+consecutiveCandles): Must all be same direction as N-2
//
// BULLISH engulfing:
//   - N-1 is bullish, N-2 is bearish
//   - N-1 low < N-2 low (swept the low)
//   - N-1 close > N-2 open (closed through the body)
//   - N-3 through N-(2+consecutiveCandles) are ALL bearish
//
// BEARISH engulfing:
//   - N-1 is bearish, N-2 is bullish
//   - N-1 high > N-2 high (swept the high)
//   - N-1 close < N-2 open (closed through the body)
//   - N-3 through N-(2+consecutiveCandles) are ALL bullish

if htfNewCandle and showSignals and not na(htfClose_1) and not na(htfOpen_2)
    bool n1Bullish = htfClose_1 > htfOpen_1
    bool n1Bearish = htfClose_1 < htfOpen_1
    bool n2Bullish = htfClose_2 > htfOpen_2
    bool n2Bearish = htfClose_2 < htfOpen_2

    // Bullish engulfing with consecutive bearish candles before
    if n1Bullish and n2Bearish and htfLow_1 < htfLow_2 and htfClose_1 > htfOpen_2
        // Check consecutive bearish candles (including the engulfed candle N-2)
        // We need N-3 through N-(2+consecutiveCandles) to be bearish
        if checkConsecutiveBearish(consecutiveCandles)
            int centerBar = math.round((completedHtfStartBar + completedHtfEndBar) / 2)
            label.new(centerBar, completedHtfLow, "▲",
                 style=label.style_label_up, color=color.new(color.white, 100),
                 textcolor=bullishSignalColor, size=size.large)

            line highRay = line.new(completedHtfEndBar, completedHtfHigh, completedHtfEndBar + 1, completedHtfHigh,
                 color=highRayColor, width=1, style=line.style_solid, extend=extend.right)
            line lowRay = line.new(completedHtfEndBar, completedHtfLow, completedHtfEndBar + 1, completedHtfLow,
                 color=lowRayColor, width=1, style=line.style_solid, extend=extend.right)
            array.push(rayLines, highRay)
            array.push(rayBirthCandle, htfCandleCount)
            array.push(rayLines, lowRay)
            array.push(rayBirthCandle, htfCandleCount)

            label.new(completedHtfEndBar, completedHtfOpen, "◆",
                 style=label.style_label_center, color=color.new(color.white, 100),
                 textcolor=openMarkerColor, size=size.small)

    // Bearish engulfing with consecutive bullish candles before
    if n1Bearish and n2Bullish and htfHigh_1 > htfHigh_2 and htfClose_1 < htfOpen_2
        // Check consecutive bullish candles (including the engulfed candle N-2)
        // We need N-3 through N-(2+consecutiveCandles) to be bullish
        if checkConsecutiveBullish(consecutiveCandles)
            int centerBar = math.round((completedHtfStartBar + completedHtfEndBar) / 2)
            label.new(centerBar, completedHtfHigh, "▼",
                 style=label.style_label_down, color=color.new(color.white, 100),
                 textcolor=bearishSignalColor, size=size.large)

            line highRay = line.new(completedHtfEndBar, completedHtfHigh, completedHtfEndBar + 1, completedHtfHigh,
                 color=highRayColor, width=1, style=line.style_solid, extend=extend.right)
            line lowRay = line.new(completedHtfEndBar, completedHtfLow, completedHtfEndBar + 1, completedHtfLow,
                 color=lowRayColor, width=1, style=line.style_solid, extend=extend.right)
            array.push(rayLines, highRay)
            array.push(rayBirthCandle, htfCandleCount)
            array.push(rayLines, lowRay)
            array.push(rayBirthCandle, htfCandleCount)

            label.new(completedHtfEndBar, completedHtfOpen, "◆",
                 style=label.style_label_center, color=color.new(color.white, 100),
                 textcolor=openMarkerColor, size=size.small)
