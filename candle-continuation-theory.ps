// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © scientificbest

//@version=5
indicator("Candle Continuation Theory [SB]", "CCT [SB]", overlay=true, max_lines_count=100, max_labels_count=100, max_boxes_count=200)

// ============================================================================
// INPUTS
// ============================================================================
htfTimeframe = input.timeframe("60", "HTF Timeframe", group="Settings")

// Debug
showHtfBoxes = input.bool(true, "Show HTF Candle Boxes (Debug)", group="Debug")
showDebugLabels = input.bool(true, "Show Debug Labels", group="Debug")

// Colors
bullishBoxColor = input.color(color.new(color.green, 80), "Bullish HTF Box", group="Colors")
bearishBoxColor = input.color(color.new(color.red, 80), "Bearish HTF Box", group="Colors")
bosColor = input.color(color.new(color.blue, 0), "BOS Color", group="Colors")

// ============================================================================
// HTF DATA - Using confirmed candle data
// ============================================================================
// Get the CURRENT HTF candle's developing values (candle N)
htfOpen = request.security(syminfo.tickerid, htfTimeframe, open, lookahead=barmerge.lookahead_on)
htfHigh = request.security(syminfo.tickerid, htfTimeframe, high, lookahead=barmerge.lookahead_on)
htfLow = request.security(syminfo.tickerid, htfTimeframe, low, lookahead=barmerge.lookahead_on)
htfClose = request.security(syminfo.tickerid, htfTimeframe, close, lookahead=barmerge.lookahead_on)
htfTime = request.security(syminfo.tickerid, htfTimeframe, time, lookahead=barmerge.lookahead_on)

// Get PREVIOUS HTF candle's values (candle N-1) - the one that just completed
// The [1] inside security refers to HTF bars, not CTF bars
htfOpen_1 = request.security(syminfo.tickerid, htfTimeframe, open[1], lookahead=barmerge.lookahead_on)
htfHigh_1 = request.security(syminfo.tickerid, htfTimeframe, high[1], lookahead=barmerge.lookahead_on)
htfLow_1 = request.security(syminfo.tickerid, htfTimeframe, low[1], lookahead=barmerge.lookahead_on)
htfClose_1 = request.security(syminfo.tickerid, htfTimeframe, close[1], lookahead=barmerge.lookahead_on)

// Get the HTF candle BEFORE the previous one (candle N-2) - for BOS comparison
htfHigh_2 = request.security(syminfo.tickerid, htfTimeframe, high[2], lookahead=barmerge.lookahead_on)
htfLow_2 = request.security(syminfo.tickerid, htfTimeframe, low[2], lookahead=barmerge.lookahead_on)

// Detect when a new HTF candle starts
bool htfNewCandle = ta.change(htfTime) != 0

// ============================================================================
// HTF CANDLE TRACKING (for drawing boxes)
// ============================================================================
// Track the current HTF candle's bar range on the CTF chart
var int currentHtfStartBar = na

// Store completed HTF candle data (for drawing the completed box)
var float completedHtfOpen = na
var float completedHtfHigh = na
var float completedHtfLow = na
var float completedHtfClose = na
var int completedHtfStartBar = na
var int completedHtfEndBar = na

// When new HTF candle starts, save the completed one for box drawing
if htfNewCandle
    // The candle that just completed (use the security [1] values)
    completedHtfOpen := htfOpen_1
    completedHtfHigh := htfHigh_1
    completedHtfLow := htfLow_1
    completedHtfClose := htfClose_1
    completedHtfStartBar := currentHtfStartBar
    completedHtfEndBar := bar_index - 1

    // New candle starts now
    currentHtfStartBar := bar_index

// ============================================================================
// DEBUG: DRAW HTF CANDLE BOXES
// ============================================================================
var box currentHtfBox = na

// Draw/update box for current developing HTF candle
if showHtfBoxes and not na(currentHtfStartBar)
    // Delete and recreate current box each bar to update it
    if not na(currentHtfBox)
        box.delete(currentHtfBox)

    bool isBullish = htfClose >= htfOpen
    color boxColor = isBullish ? bullishBoxColor : bearishBoxColor

    currentHtfBox := box.new(currentHtfStartBar, htfHigh, bar_index, htfLow,
         bgcolor=boxColor, border_color=color.new(isBullish ? color.green : color.red, 50), border_width=1)

// Draw box for completed HTF candle when it finishes
if htfNewCandle and showHtfBoxes and not na(completedHtfStartBar) and not na(completedHtfEndBar)
    bool wasHtfBullish = completedHtfClose >= completedHtfOpen
    color completedBoxColor = wasHtfBullish ? bullishBoxColor : bearishBoxColor

    box.new(completedHtfStartBar, completedHtfHigh, completedHtfEndBar, completedHtfLow,
         bgcolor=completedBoxColor, border_color=color.new(wasHtfBullish ? color.green : color.red, 30), border_width=2)

// ============================================================================
// BOS DETECTION
// ============================================================================
// BOS occurs when an HTF candle CLOSES above the previous HTF candle's HIGH
// or CLOSES below the previous HTF candle's LOW
//
// When htfNewCandle fires:
//   - htfClose_1 = close of candle that JUST completed (N-1)
//   - htfHigh_2 = high of the candle BEFORE that (N-2)
//   - htfLow_2 = low of the candle BEFORE that (N-2)
//
// BOS↑: htfClose_1 > htfHigh_2 (completed candle closed above prior candle's high)
// BOS↓: htfClose_1 < htfLow_2 (completed candle closed below prior candle's low)

var bool bullishBosDetected = false
var bool bearishBosDetected = false

if htfNewCandle and not na(htfClose_1) and not na(htfHigh_2) and not na(htfLow_2)
    // Check if the just-completed HTF candle closed above the prior HTF candle's high
    if htfClose_1 > htfHigh_2
        bullishBosDetected := true
        bearishBosDetected := false

        // Mark BOS on the chart at the start of the new candle
        if showDebugLabels
            label.new(bar_index, htfHigh_1, "BOS↑\nClose(N-1): " + str.tostring(htfClose_1, "#.##") + "\nHigh(N-2): " + str.tostring(htfHigh_2, "#.##"),
                 style=label.style_label_down, color=bosColor, textcolor=color.white, size=size.small)

    // Check if the just-completed HTF candle closed below the prior HTF candle's low
    else if htfClose_1 < htfLow_2
        bearishBosDetected := true
        bullishBosDetected := false

        // Mark BOS on the chart at the start of the new candle
        if showDebugLabels
            label.new(bar_index, htfLow_1, "BOS↓\nClose(N-1): " + str.tostring(htfClose_1, "#.##") + "\nLow(N-2): " + str.tostring(htfLow_2, "#.##"),
                 style=label.style_label_up, color=bosColor, textcolor=color.white, size=size.small)

    else
        bullishBosDetected := false
        bearishBosDetected := false

// ============================================================================
// DEBUG: Show current values
// ============================================================================
var label debugLabel = na
if showDebugLabels
    if not na(debugLabel)
        label.delete(debugLabel)

    string debugText = "HTF: " + htfTimeframe +
         "\n--- Current (N) ---" +
         "\nO: " + str.tostring(htfOpen, "#.##") +
         " H: " + str.tostring(htfHigh, "#.##") +
         "\nL: " + str.tostring(htfLow, "#.##") +
         " C: " + str.tostring(htfClose, "#.##") +
         "\n--- Previous (N-1) ---" +
         "\nH: " + str.tostring(htfHigh_1, "#.##") +
         " L: " + str.tostring(htfLow_1, "#.##") +
         " C: " + str.tostring(htfClose_1, "#.##") +
         "\n--- Prior (N-2) ---" +
         "\nH: " + str.tostring(htfHigh_2, "#.##") +
         " L: " + str.tostring(htfLow_2, "#.##") +
         "\n--- BOS Check ---" +
         "\nClose(N-1) > High(N-2)? " + str.tostring(htfClose_1 > htfHigh_2) +
         "\nClose(N-1) < Low(N-2)? " + str.tostring(htfClose_1 < htfLow_2)

    debugLabel := label.new(bar_index + 5, high, debugText,
         style=label.style_label_left, color=color.new(color.gray, 50), textcolor=color.white, size=size.small)
