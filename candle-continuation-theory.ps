// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © scientificbest

//@version=5
indicator("Candle Continuation Theory [SB]", "CCT [SB]", overlay=true, max_lines_count=100, max_labels_count=100, max_boxes_count=200)

// ============================================================================
// INPUTS
// ============================================================================
htfTimeframe = input.timeframe("60", "HTF Timeframe", group="Settings")

// Debug
showHtfBoxes = input.bool(true, "Show HTF Candle Boxes (Debug)", group="Debug")
showDebugLabels = input.bool(true, "Show Debug Labels", group="Debug")

// Colors
bullishBoxColor = input.color(color.new(color.green, 80), "Bullish HTF Box", group="Colors")
bearishBoxColor = input.color(color.new(color.red, 80), "Bearish HTF Box", group="Colors")
bosColor = input.color(color.new(color.blue, 0), "BOS Color", group="Colors")

// ============================================================================
// HTF DATA - Using confirmed candle data
// ============================================================================
// Get the CURRENT HTF candle's developing values
htfOpen = request.security(syminfo.tickerid, htfTimeframe, open, lookahead=barmerge.lookahead_on)
htfHigh = request.security(syminfo.tickerid, htfTimeframe, high, lookahead=barmerge.lookahead_on)
htfLow = request.security(syminfo.tickerid, htfTimeframe, low, lookahead=barmerge.lookahead_on)
htfClose = request.security(syminfo.tickerid, htfTimeframe, close, lookahead=barmerge.lookahead_on)
htfTime = request.security(syminfo.tickerid, htfTimeframe, time, lookahead=barmerge.lookahead_on)

// Detect when a new HTF candle starts
bool htfNewCandle = ta.change(htfTime) != 0

// ============================================================================
// HTF CANDLE TRACKING
// ============================================================================
// Track the current HTF candle's bar range on the CTF chart
var int currentHtfStartBar = na

// Store completed HTF candle data
var float completedHtfOpen = na
var float completedHtfHigh = na
var float completedHtfLow = na
var float completedHtfClose = na
var int completedHtfStartBar = na
var int completedHtfEndBar = na

// Store the previous completed HTF candle (for BOS comparison)
var float prevCompletedHtfHigh = na
var float prevCompletedHtfLow = na

// When new HTF candle starts, save the completed one
if htfNewCandle
    // Save previous completed candle's high/low for BOS comparison
    prevCompletedHtfHigh := completedHtfHigh
    prevCompletedHtfLow := completedHtfLow

    // The candle that just completed
    completedHtfOpen := htfOpen[1]
    completedHtfHigh := htfHigh[1]
    completedHtfLow := htfLow[1]
    completedHtfClose := htfClose[1]
    completedHtfStartBar := currentHtfStartBar
    completedHtfEndBar := bar_index - 1

    // New candle starts now
    currentHtfStartBar := bar_index

// ============================================================================
// DEBUG: DRAW HTF CANDLE BOXES
// ============================================================================
var box currentHtfBox = na

// Draw/update box for current developing HTF candle
if showHtfBoxes and not na(currentHtfStartBar)
    // Delete and recreate current box each bar to update it
    if not na(currentHtfBox)
        box.delete(currentHtfBox)

    bool isBullish = htfClose >= htfOpen
    color boxColor = isBullish ? bullishBoxColor : bearishBoxColor

    currentHtfBox := box.new(currentHtfStartBar, htfHigh, bar_index, htfLow,
         bgcolor=boxColor, border_color=color.new(isBullish ? color.green : color.red, 50), border_width=1)

// Draw box for completed HTF candle when it finishes
if htfNewCandle and showHtfBoxes and not na(completedHtfStartBar) and not na(completedHtfEndBar)
    bool wasHtfBullish = completedHtfClose >= completedHtfOpen
    color completedBoxColor = wasHtfBullish ? bullishBoxColor : bearishBoxColor

    box.new(completedHtfStartBar, completedHtfHigh, completedHtfEndBar, completedHtfLow,
         bgcolor=completedBoxColor, border_color=color.new(wasHtfBullish ? color.green : color.red, 30), border_width=2)

// ============================================================================
// BOS DETECTION
// ============================================================================
// BOS occurs when an HTF candle CLOSES above the previous HTF candle's HIGH
// or CLOSES below the previous HTF candle's LOW

var bool bullishBosDetected = false
var bool bearishBosDetected = false

if htfNewCandle and not na(prevCompletedHtfHigh) and not na(prevCompletedHtfLow) and not na(completedHtfClose)
    // Check if the just-completed HTF candle closed above previous HTF high
    if completedHtfClose > prevCompletedHtfHigh
        bullishBosDetected := true
        bearishBosDetected := false

        // Mark BOS on the chart
        if showDebugLabels
            label.new(bar_index, completedHtfHigh, "BOS↑\nClose: " + str.tostring(completedHtfClose, "#.##") + "\nPrev High: " + str.tostring(prevCompletedHtfHigh, "#.##"),
                 style=label.style_label_down, color=bosColor, textcolor=color.white, size=size.small)

    // Check if the just-completed HTF candle closed below previous HTF low
    else if completedHtfClose < prevCompletedHtfLow
        bearishBosDetected := true
        bullishBosDetected := false

        // Mark BOS on the chart
        if showDebugLabels
            label.new(bar_index, completedHtfLow, "BOS↓\nClose: " + str.tostring(completedHtfClose, "#.##") + "\nPrev Low: " + str.tostring(prevCompletedHtfLow, "#.##"),
                 style=label.style_label_up, color=bosColor, textcolor=color.white, size=size.small)

    else
        bullishBosDetected := false
        bearishBosDetected := false

// ============================================================================
// DEBUG: Show current values
// ============================================================================
var label debugLabel = na
if showDebugLabels
    if not na(debugLabel)
        label.delete(debugLabel)

    string debugText = "HTF: " + htfTimeframe +
         "\nCurrent HTF O: " + str.tostring(htfOpen, "#.##") +
         "\nCurrent HTF H: " + str.tostring(htfHigh, "#.##") +
         "\nCurrent HTF L: " + str.tostring(htfLow, "#.##") +
         "\nCurrent HTF C: " + str.tostring(htfClose, "#.##") +
         "\n---" +
         "\nPrev HTF High: " + str.tostring(prevCompletedHtfHigh, "#.##") +
         "\nPrev HTF Low: " + str.tostring(prevCompletedHtfLow, "#.##")

    debugLabel := label.new(bar_index + 5, high, debugText,
         style=label.style_label_left, color=color.new(color.gray, 50), textcolor=color.white, size=size.small)
